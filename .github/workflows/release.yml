name: Update Homebrew Formula

on:
  release:
    types: [published]

jobs:
  update-formula:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout the sportskalender-in-terminal repo
        uses: actions/checkout@v2

      - name: Clone Homebrew Tap
        run: |
          git clone https://x-access-token:${{ secrets.PUBLISHER_TOKEN }}@github.com/hbleie/homebrew-hbleie.git homebrew-hbleie

      - name: Update Homebrew Formula
        run: |
          # Fetch the latest release version
          VERSION=$(echo "${GITHUB_REF}" | sed 's|refs/tags/||')
          SHA256=$(curl -L -s "https://github.com/hbleie/sportskalender-in-terminal/releases/download/${VERSION}/sportskalender-in-terminal.plugin.zsh" | shasum -a 256 | awk '{print $1}')
          
          # Update the formula file
          sed -i.bak "s/version \"[^\"]*\"/version \"${VERSION}\"/" homebrew-hbleie/sportskalender-in-terminal.rb
          sed -i.bak "s/sha256 \"[^\"]*\"/sha256 \"${SHA256}\"/" homebrew-hbleie/sportskalender-in-terminal.rb
          
          # Clean up backup file
          rm homebrew-hbleie/sportskalender-in-terminal.rb.bak

      - name: Create Release Asset
        run: |
          VERSION=$(echo "${GITHUB_REF}" | sed 's|refs/tags/||')
          # Create a tar.gz file including the JavaScript files and the Zsh plugin
          tar -czvf sportskalender-in-terminal-${VERSION}.tar.gz \
              sportskalender-in-terminal.plugin.zsh \
              fotball.js \
              hoydepunkter.js \
              vintersport.js
          
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        with:
          upload_url: ${{ github.event.release.upload_url }}
          asset_path: sportskalender-in-terminal-${VERSION}.tar.gz
          asset_name: sportskalender-in-terminal-${VERSION}.tar.gz
          asset_content_type: application/gzip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Use the default token provided by GitHub

      - name: Commit changes
        run: |
          cd homebrew-hbleie
          git config --local user.name "github-actions"
          git config --local user.email "github-actions@github.com"
          git add sportskalender-in-terminal.rb
          git commit -m "Update formula for version ${VERSION}" || echo "No changes to commit"
      
      - name: Push changes
        run: |
          cd homebrew-hbleie
          git push origin main
